<!DOCTYPE html>
<html lang="en">
<head>
 <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('groleegni.net',9237191,document.createElement('script'))</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="monetag" content="3aebd9ebbba1b779613f4488fb3b0da1" />
  <title>Tap to Earn - Money Master</title>
  <link rel="stylesheet" href="tap.css" />
  <link rel="icon" href="assets/money_master_favicon.png" />

  <!-- Firebase CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVUzBgRChD8FhdgMoKosCLpLX3zGgWB_0",
      authDomain: "money-master-official-site-new.firebaseapp.com",
      projectId: "money-master-official-site-new",
      storageBucket: "money-master-official-site-new.appspot.com",
      messagingSenderId: "580013071708",
      appId: "1:580013071708:web:76363a43638401cda07599",
      measurementId: "G-26CBLGCKC1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
  </script>
</head>
<body onload="initTapPage()">

  <!-- Dashboard Icon -->
  <img src="assets/icon_dashboard.png" class="dashboard-icon" id="dashboardIcon" onclick="goToDashboard()" alt="Dashboard" />

  <!-- Tap Area -->
  <div class="tap-container" id="tapZone">
    <img src="assets/bitcoin_idle.png" id="tapIcon" alt="Bitcoin Tap Icon" />
    <p>COINS: <span id="coinCount">0</span></p>
  </div>

  <!-- Sounds -->
  <audio id="tapSound" src="assets/tap_sound.mp3" preload="auto"></audio>
  <audio id="reminderSound" src="assets/reminder_user.mp3" preload="auto"></audio>

  <!-- Ripple CSS -->
  <style>
    .tap-ripple {
      position: fixed;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(0, 255, 255, 0.4);
      transform: translate(-50%, -50%) scale(0);
      animation: ripple 0.5s ease-out forwards;
      pointer-events: none;
      z-index: 999;
    }
    @keyframes ripple {
      to {
        transform: translate(-50%, -50%) scale(2);
        opacity: 0;
      }
    }
  </style>

  <!-- Tap Script -->
  <script type="module">
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    let firstTap = true;
    let reminderPlayed = false;
    const db = window.db;

    function initTapPage() {
      const uid = localStorage.getItem("userUID");
      if (!uid) {
        alert("Please login first.");
        window.location.href = "index.html";
        return;
      }

      setTimeout(() => {
        if (!reminderPlayed) {
          document.getElementById("reminderSound").play().catch(() => {});
          reminderPlayed = true;
        }
      }, 360000);

      loadInitialCoins();
    }

    async function loadInitialCoins() {
      const uid = localStorage.getItem("userUID");
      if (!uid) return;
      const userRef = doc(db, "User", uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        const coins = snap.data().coins || 0;
        document.getElementById("coinCount").textContent = coins;
      }
    }

    function goToDashboard() {
      window.location.href = "dashboard.html";
    }

    async function handleTap(e) {
      const tapIcon = document.getElementById("tapIcon");
      const tapSound = document.getElementById("tapSound");
      const coinCountEl = document.getElementById("coinCount");

      tapSound.currentTime = 0;
      tapSound.play().catch(() => {});

      tapIcon.style.transform = "rotate(-20deg)";
      setTimeout(() => {
        tapIcon.style.transform = "rotate(0deg)";
      }, 100);

      let coins = parseInt(coinCountEl.textContent);
      coins += 1;
      coinCountEl.textContent = coins;
      updateFirestoreCoins(coins);

      const ripple = document.createElement("span");
      ripple.className = "tap-ripple";
      ripple.style.left = `${e.clientX}px`;
      ripple.style.top = `${e.clientY}px`;
      document.body.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
    }

    async function updateFirestoreCoins(newCoins) {
      const uid = localStorage.getItem("userUID");
      if (!uid) return;
      const userRef = doc(db, "User", uid);
      try {
        await updateDoc(userRef, { coins: newCoins });
      } catch (err) {
        console.error("Firestore update error:", err);
      }
    }

    document.body.addEventListener("click", function (e) {
      const clickedAd = e.target.tagName === "IFRAME" || e.target.classList.contains("ad") || e.target.closest(".ad");
      const clickedDashboard = e.target.id === "dashboardIcon";

      if (!clickedAd && !clickedDashboard) {
        handleTap(e);

        if (firstTap) {
          const adScript = document.createElement("script");
          adScript.src = "https://www.profitableratecpm.com/ibu3q4xj87?key=15bf92f761739f1b94851ca0199f3b33";
          adScript.async = true;
          document.body.appendChild(adScript);
          firstTap = false;
        }
      }
    });

    window.initTapPage = initTapPage;
  </script>
</body>
</html>
